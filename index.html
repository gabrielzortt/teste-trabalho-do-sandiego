<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Venda de eBooks - Creators of the Future</title>
  <link rel="stylesheet" href="style.css" />
  <!-- NOTE: EmailJS SDK ser√° carregado no final (parte 3) -->
</head>
<body>
  <!-- Barra de pesquisa -->
  <header>
    <div class="search-container">
      <input type="text" class="search-bar" placeholder="Pesquisar produtos..." />
    </div>
  </header>

  <!-- Produto n√£o encontrado -->
  <div id="sem-produto" style="display:none; text-align:center; margin-top:20px;">
    <h2>Produto n√£o identificado</h2>
  </div>

  <!-- Se√ß√£o Quem Somos -->
  <section id="quem-somos">
    <h2>Quem Somos</h2>
    <img src="https://github.com/gabrielzortt/Venda-de-Ebook/blob/main/05552d41-df4b-4b4a-abd2-0991d4e63a57.jpg?raw=true" 
         alt="Logo Creators of the Future" 
         class="logo-quem-somos" />
    <p>
      Na <strong>Creators of the Future</strong>, acreditamos que o conhecimento √© a chave para a liberdade financeira e para a realiza√ß√£o pessoal. Nossa miss√£o √© transformar vidas, oferecendo conte√∫dos pr√°ticos e objetivos que capacitam jovens e microempreendedores a conquistar seus sonhos no mundo digital.  
      <br><br>
      Com anos de experi√™ncia no mercado digital, reunimos as melhores estrat√©gias, t√©cnicas e ferramentas em nossos eBooks, garantindo que voc√™ aprenda de forma r√°pida, eficiente e segura. Aqui, voc√™ n√£o encontra teorias vazias, mas m√©todos testados que realmente funcionam.  
      <br><br>
      Junte-se a n√≥s e descubra como transformar ideias em resultados, desafios em oportunidades e potencial em sucesso. Estamos aqui para gui√°-lo em cada passo da sua jornada empreendedora, para que voc√™ possa construir um futuro s√≥lido, pr√≥spero e cheio de realiza√ß√µes!
    </p>
  </section>

  <!-- Se√ß√£o de Produtos -->
  <section class="outros-ebooks">
    <h2>eBook em Destaque</h2>
    
    <!-- Produto real com imagem -->
    <div class="produto destaque">
      <img src="https://raw.githubusercontent.com/gabrielzortt/Venda-de-Ebook/refs/heads/main/capa.jpg" 
           alt="Como Ganhar Dinheiro com o Celular" />
      <div class="produto-info">
        <h3>üì± Como Ganhar Dinheiro com o Celular</h3>
        <p>Aprenda m√©todos pr√°ticos e testados para come√ßar a ganhar dinheiro com seu celular ainda hoje!</p>
        <div class="valor">üí∞ R$ 19,90</div>
        <button onclick="window.location.href='https://pay.kiwify.com.br/QHHVus7';">
          üì≤ Comprar Agora
        </button>
      </div>
    </div>
    <h2>Outros eBooks</h2>
    <div class="grid-produtos">
      <!-- Produto 2 sem imagem -->
      <div class="produto">
        <div class="produto-info">
          <h3>üíª Empreendedorismo Digital para Iniciantes</h3>
          <p>Aprenda a criar e gerir seu pr√≥prio neg√≥cio digital com baixo investimento inicial!</p>
          <div class="valor">üí∞ R$ 29,90</div>
          <button>üì≤ Comprar Agora</button>
        </div>
      </div>

      <!-- Produto 3 sem imagem -->
      <div class="produto">
        <div class="produto-info">
          <h3>üìä Investindo para Iniciantes - Comece com R$ 100</h3>
          <p>Descubra como investir de forma segura mesmo com pouco dinheiro. Ideal para iniciantes!</p>
          <div class="valor">üí∞ R$ 19,90</div>
          <button>üì≤ Comprar Agora</button>
        </div>
      </div>

      <!-- Produto 4 sem imagem -->
      <div class="produto">
        <div class="produto-info">
          <h3>üíª Vendas Online - Como Criar Seu Neg√≥cio</h3>
          <p>Saiba como construir uma loja virtual, fazer an√∫ncios e gerar vendas de forma automatizada.</p>
          <div class="valor">üí∞ R$ 39,90</div>
          <button>üì≤ Comprar Agora</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Se√ß√£o de D√∫vidas Frequentes -->
  <section id="duvidas">
    <h2>D√∫vidas Frequentes</h2>
    <div class="faq">
      <div class="pergunta">
        <h4>‚ùì Como fa√ßo para acessar o eBook ap√≥s a compra?</h4>
        <p>Ap√≥s a confirma√ß√£o do pagamento, voc√™ receber√° um link para download em seu e-mail.</p>
      </div>
      <div class="pergunta">
        <h4>‚ùì Posso ler os eBooks no celular e no computador?</h4>
        <p>Sim! Nossos eBooks s√£o compat√≠veis com todos os dispositivos, incluindo smartphones, tablets e computadores.</p>
      </div>
      <div class="pergunta">
        <h4>‚ùì Existe garantia de satisfa√ß√£o?</h4>
        <p>Sim, oferecemos 7 dias para solicitar reembolso caso n√£o esteja satisfeito com o conte√∫do.</p>
      </div>
      <div class="pergunta">
        <h4>‚ùì Os m√©todos ensinados realmente funcionam?</h4>
        <p>Sim! Todos os m√©todos s√£o testados e comprovados por nossos especialistas no mercado digital.</p>
      </div>
    </div>
  </section>

  <!-- Se√ß√£o de Avalia√ß√µes -->
  <section id="avaliacoes">
    <h2>Avalia√ß√µes dos Usu√°rios</h2>
    <div class="avaliacoes-geral">
      <div class="avaliacao">
        <h4>Lucas M.</h4>
        <p>Excelente conte√∫do! Consegui aplicar as t√©cnicas e j√° vi resultados no primeiro m√™s. Recomendo!</p>
        <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
      </div>
      <div class="avaliacao">
        <h4>Julia T.</h4>
        <p>O eBook √© incr√≠vel, muito pr√°tico e f√°cil de entender. As dicas realmente funcionam.</p>
        <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
      </div>
      <div class="avaliacao">
        <h4>Carlos P.</h4>
        <p>Aprendi muito em pouco tempo. Material de alta qualidade e bem explicado.</p>
        <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
      </div>
    </div>
  </section>

  <!-- Se√ß√£o de Ajuda -->
  <section id="ajuda">
    <h2>Precisa de Ajuda?</h2>
    <p>Se tiver qualquer d√∫vida ou problema, entre em contato conosco pelo telefone:</p>
    <p class="telefone">üìû (92) 99427-4276</p>
  </section>

  <!-- Rodap√© -->
  <footer>
    <p>&copy; 2025 Creators of the Future - Todos os direitos reservados.</p>
  </footer>

  <!-- Scripts principais do site -->
  <script>
    // FAQ interativo com anima√ß√£o
    const perguntas = document.querySelectorAll('.faq .pergunta');
    perguntas.forEach(pergunta => {
      pergunta.addEventListener('click', () => {
        const resposta = pergunta.querySelector('p');
        if(resposta.style.display === 'block'){
          resposta.style.display = 'none';
          pergunta.classList.remove('ativo');
        } else {
          resposta.style.display = 'block';
          pergunta.classList.add('ativo');
        }
      });
    });

    // Pesquisa com filtro e produto n√£o identificado
    const searchInput = document.querySelector(".search-bar");
    const produtos = document.querySelectorAll(".produto");
    const quemSomos = document.getElementById("quem-somos");
    const outrosEbooks = document.querySelector(".outros-ebooks");
    const duvidas = document.getElementById("duvidas");
    const avaliacoes = document.getElementById("avaliacoes");
    const ajuda = document.getElementById("ajuda");
    const semProduto = document.getElementById("sem-produto");

    function filtrarProdutos() {
      const termo = searchInput.value.toLowerCase();
      let encontrado = false;

      produtos.forEach(produto => {
        const texto = produto.innerText.toLowerCase();
        if (texto.includes(termo)) {
          produto.style.display = "flex";
          encontrado = true;
        } else {
          produto.style.display = "none";
        }
      });

      if (termo === "") {
        // Campo vazio: mostrar tudo
        quemSomos.style.display = "block";
        outrosEbooks.style.display = "block";
        duvidas.style.display = "block";
        avaliacoes.style.display = "block";
        ajuda.style.display = "block";
        semProduto.style.display = "none";
        produtos.forEach(p => p.style.display = "flex");
      } else if (!encontrado) {
        // Produto n√£o encontrado
        quemSomos.style.display = "none";
        outrosEbooks.style.display = "none";
        duvidas.style.display = "none";
        avaliacoes.style.display = "none";
        ajuda.style.display = "none";
        semProduto.style.display = "block";
      } else {
        // Produto encontrado
        quemSomos.style.display = "none";
        outrosEbooks.style.display = "block";
        duvidas.style.display = "none";
        avaliacoes.style.display = "none";
        ajuda.style.display = "none";
        semProduto.style.display = "none";
      }
    }

    searchInput.addEventListener("input", filtrarProdutos);
  </script>

  <!-- CSS isolado para a sess√£o de usu√°rio (n√£o altera seu style.css) -->
  <style>
    /* CSS isolado para a sess√£o de usu√°rio - prefixo sessao-usuario- */
    .sessao-usuario-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:99999}
    .sessao-usuario-modal{background:#fff;border-radius:12px;max-width:520px;width:96%;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,.25);font-family:inherit}
    .sessao-usuario-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .sessao-usuario-title{font-size:18px;font-weight:700}
    .sessao-usuario-close{background:transparent;border:0;font-size:22px;cursor:pointer}
    .sessao-usuario-form{display:flex;flex-direction:column;gap:10px}
    .sessao-usuario-input{padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px;width:100%}
    .sessao-usuario-btn{padding:10px 14px;border-radius:8px;border:0;background:#1a237e;color:#fff;font-weight:700;cursor:pointer}
    .sessao-usuario-secondary{background:transparent;color:#1a237e;border:1px solid #1a237e}
    .sessao-usuario-note{font-size:13px;color:#666}
    .sessao-usuario-flex{display:flex;gap:10px;align-items:center}
    .sessao-usuario-avatar{width:72px;height:72px;border-radius:10px;object-fit:cover;border:1px solid #eee}
    .sessao-usuario-footer{margin-top:10px;display:flex;justify-content:space-between;align-items:center}
    .sessao-usuario-floating{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:12px 14px;border-radius:999px;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:99998;cursor:pointer;font-weight:700;border:0}
    .sessao-usuario-link{background:none;border:0;color:#1a237e;cursor:pointer;font-size:14px;padding:0}
    .sessao-usuario-hidden{display:none}
    .sessao-usuario-error{color:#b00020;font-size:13px}
    .sessao-usuario-success{color:green;font-size:13px}
    @media (max-width:480px){
      .sessao-usuario-modal{padding:14px}
      .sessao-usuario-avatar{width:56px;height:56px}
    }
  </style>

  <div id="sessao-usuario-root"></div>
  <script>
  (function(){
    // --- Helpers criptogr√°ficos (Web Crypto) ---
    const textEncoder = new TextEncoder();

    function toHex(buffer){
      return Array.from(new Uint8Array(buffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function fromHex(hex){
      const bytes = new Uint8Array(hex.length/2);
      for(let i=0;i<bytes.length;i++) bytes[i]=parseInt(hex.substr(i*2,2),16);
      return bytes.buffer;
    }
    async function derivePasswordHash(password, saltHex, iterations=120000){
      const salt = saltHex ? new Uint8Array(fromHex(saltHex)) : crypto.getRandomValues(new Uint8Array(16));
      const keyMaterial = await crypto.subtle.importKey('raw', textEncoder.encode(password), {name:'PBKDF2'}, false, ['deriveBits']);
      const derived = await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations,hash:'SHA-256'}, keyMaterial, 256);
      return {hashHex: toHex(derived), saltHex: toHex(salt)};
    }

    // --- Storage helpers ---
    function loadUsers(){ try { return JSON.parse(localStorage.getItem('sessao_users')||'{}'); } catch(e){ return {}; } }
    function saveUsers(obj){ localStorage.setItem('sessao_users', JSON.stringify(obj)); }
    function setCurrent(email){ localStorage.setItem('sessao_current', email || ''); }
    function getCurrent(){ return localStorage.getItem('sessao_current') || ''; }
    function saveResetToken(email, token, expiresAt){
      const tokens = JSON.parse(localStorage.getItem('sessao_reset_tokens')||'{}');
      tokens[email] = {token, expiresAt};
      localStorage.setItem('sessao_reset_tokens', JSON.stringify(tokens));
    }
    function getResetToken(email){
      const tokens = JSON.parse(localStorage.getItem('sessao_reset_tokens')||'{}');
      return tokens[email] || null;
    }
    function removeResetToken(email){
      const tokens = JSON.parse(localStorage.getItem('sessao_reset_tokens')||'{}');
      delete tokens[email];
      localStorage.setItem('sessao_reset_tokens', JSON.stringify(tokens));
    }

    // --- UI injection ---
    const root = document.getElementById('sessao-usuario-root');
    root.innerHTML = `
      <button id="sessao-usuario-floating" class="sessao-usuario-floating" title="Minha Conta">Minha Conta</button>
      <div id="sessao-usuario-overlay" class="sessao-usuario-overlay" aria-hidden="true">
        <div class="sessao-usuario-modal" role="dialog" aria-modal="true" id="sessao-usuario-modal"></div>
      </div>
    `;

    const overlay = document.getElementById('sessao-usuario-overlay');
    const modal = document.getElementById('sessao-usuario-modal');
    const floatingBtn = document.getElementById('sessao-usuario-floating');

    function openModal(html){ modal.innerHTML = html; overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); }
    function closeModal(){ overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); }
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // --- Templates ---
    function loginTemplate(msg=''){
      return `
        <div class="sessao-usuario-header">
          <div class="sessao-usuario-title">Entrar</div>
          <button class="sessao-usuario-close" data-action="close">&times;</button>
        </div>
        <form id="sessao-usuario-login" class="sessao-usuario-form">
          <input class="sessao-usuario-input" id="sessao-usuario-login-email" placeholder="E-mail" type="email" required />
          <input class="sessao-usuario-input" id="sessao-usuario-login-password" placeholder="Senha" type="password" required />
          <div class="sessao-usuario-error" id="sessao-usuario-login-msg">${msg}</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <button class="sessao-usuario-btn" type="submit">Entrar</button>
            <button type="button" class="sessao-usuario-link" id="sessao-usuario-to-signup">Criar conta</button>
          </div>
          <div class="sessao-usuario-footer">
            <button type="button" class="sessao-usuario-link" id="sessao-usuario-forgot">Esqueci a senha</button>
          </div>
        </form>
      `;
    }

    function signupTemplate(msg=''){
      return `
        <div class="sessao-usuario-header">
          <div class="sessao-usuario-title">Criar Conta</div>
          <button class="sessao-usuario-close" data-action="close">&times;</button>
        </div>
        <form id="sessao-usuario-signup" class="sessao-usuario-form">
          <input class="sessao-usuario-input" id="sessao-usuario-signup-name" placeholder="Nome completo" type="text" required />
          <input class="sessao-usuario-input" id="sessao-usuario-signup-email" placeholder="E-mail" type="email" required />
          <input class="sessao-usuario-input" id="sessao-usuario-signup-password" placeholder="Senha (m√≠n 8 caracteres)" type="password" required />
          <div class="sessao-usuario-note sessao-usuario-small">Voc√™ poder√° adicionar foto depois no perfil.</div>
          <div class="sessao-usuario-error" id="sessao-usuario-signup-msg">${msg}</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <button class="sessao-usuario-btn" type="submit">Cadastrar</button>
            <button type="button" class="sessao-usuario-link" id="sessao-usuario-to-login">J√° tenho conta</button>
          </div>
        </form>
      `;
    }
    function forgotTemplate(){
      return `
        <div class="sessao-usuario-header">
          <div class="sessao-usuario-title">Recuperar Senha</div>
          <button class="sessao-usuario-close" data-action="close">&times;</button>
        </div>
        <form id="sessao-usuario-forgot-form" class="sessao-usuario-form">
          <input class="sessao-usuario-input" id="sessao-usuario-forgot-email" placeholder="Digite seu e-mail" type="email" required />
          <div class="sessao-usuario-note">Ser√° gerado um token de recupera√ß√£o. Um e-mail ser√° enviado para o endere√ßo informado.</div>
          <div class="sessao-usuario-success sessao-usuario-hidden" id="sessao-usuario-forgot-success"></div>
          <div class="sessao-usuario-error" id="sessao-usuario-forgot-msg"></div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <button class="sessao-usuario-btn" type="submit">Gerar token</button>
            <button class="sessao-usuario-link" type="button" id="sessao-usuario-to-login-2">Voltar</button>
          </div>
        </form>
      `;
    }

    function resetTemplate(){
      return `
        <div class="sessao-usuario-header">
          <div class="sessao-usuario-title">Resetar Senha</div>
          <button class="sessao-usuario-close" data-action="close">&times;</button>
        </div>
        <form id="sessao-usuario-reset-form" class="sessao-usuario-form">
          <input class="sessao-usuario-input" id="sessao-usuario-reset-email" placeholder="E-mail" type="email" required />
          <input class="sessao-usuario-input" id="sessao-usuario-reset-token" placeholder="Token de recupera√ß√£o" type="text" required />
          <input class="sessao-usuario-input" id="sessao-usuario-reset-password" placeholder="Nova senha" type="password" required />
          <div class="sessao-usuario-error" id="sessao-usuario-reset-msg"></div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <button class="sessao-usuario-btn" type="submit">Resetar senha</button>
            <button class="sessao-usuario-link" type="button" id="sessao-usuario-to-login-3">Voltar</button>
          </div>
        </form>
      `;
    }

    function profileTemplate(user){
      const photoHtml = user.photoDataUrl ? `<img src="${user.photoDataUrl}" class="sessao-usuario-avatar" id="sessao-usuario-avatar-img" />` : `<div style="width:72px;height:72px;border-radius:10px;background:#f1f1f1;display:flex;align-items:center;justify-content:center;color:#666" id="sessao-usuario-avatar-img">Sem foto</div>`;
      return `
        <div class="sessao-usuario-header">
          <div class="sessao-usuario-title">Minha Conta</div>
          <button class="sessao-usuario-close" data-action="close">&times;</button>
        </div>
        <div class="sessao-usuario-form" id="sessao-usuario-profile-form">
          <div class="sessao-usuario-flex">
            ${photoHtml}
            <div style="flex:1">
              <input class="sessao-usuario-input" id="sessao-usuario-profile-name" value="${user.name || ''}" placeholder="Nome completo" />
              <input class="sessao-usuario-input" id="sessao-usuario-profile-email" value="${user.email || ''}" placeholder="E-mail" />
              <label class="sessao-usuario-note">Alterar foto: <input type="file" id="sessao-usuario-profile-photo" accept="image/*" /></label>
            </div>
          </div>

          <hr />

          <div class="sessao-usuario-note">Alterar senha</div>
          <input class="sessao-usuario-input" id="sessao-usuario-profile-current-password" placeholder="Senha atual (necess√°rio para trocar)" type="password" />
          <input class="sessao-usuario-input" id="sessao-usuario-profile-new-password" placeholder="Nova senha" type="password" />
          <div class="sessao-usuario-error" id="sessao-usuario-profile-msg"></div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="sessao-usuario-link" id="sessao-usuario-logout">Sair</button>
            <button class="sessao-usuario-btn" id="sessao-usuario-save-profile">Salvar</button>
          </div>
        </div>
      `;
    }

    // --- Actions & Handlers ---
    function showLogin(msg=''){ openModal(loginTemplate(msg)); initLoginHandlers(); }
    function showSignup(msg=''){ openModal(signupTemplate(msg)); initSignupHandlers(); }
    function showForgot(){ openModal(forgotTemplate()); initForgotHandlers(); }
    function showReset(){ openModal(resetTemplate()); initResetHandlers(); }
    function showProfile(){ 
      const users = loadUsers();
      const current = getCurrent();
      if(!current || !users[current]){ showLogin(); return; }
      openModal(profileTemplate({name:users[current].name, email: users[current].email, photoDataUrl: users[current].photoDataUrl}));
      initProfileHandlers();
    }

    function initLoginHandlers(){
      modal.querySelector('[data-action="close"]').addEventListener('click', closeModal);
      modal.querySelector('#sessao-usuario-to-signup').addEventListener('click', ()=> showSignup());
      modal.querySelector('#sessao-usuario-forgot').addEventListener('click', ()=> showForgot());
      modal.querySelector('#sessao-usuario-login').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = modal.querySelector('#sessao-usuario-login-email').value.trim().toLowerCase();
        const password = modal.querySelector('#sessao-usuario-login-password').value;
        const users = loadUsers();
        const msgEl = modal.querySelector('#sessao-usuario-login-msg');
        msgEl.textContent = '';
        if(!users[email]){ msgEl.textContent = 'Conta n√£o encontrada.'; return; }
        const {saltHex, hashHex: storedHash} = users[email];
        const {hashHex} = await derivePasswordHash(password, saltHex);
        if(hashHex !== storedHash){ msgEl.textContent = 'Senha incorreta.'; return; }
        setCurrent(email);
        closeModal();
        onAuthChange(true);
      });
    }

    function initSignupHandlers(){
      modal.querySelector('[data-action="close"]').addEventListener('click', closeModal);
      modal.querySelector('#sessao-usuario-to-login').addEventListener('click', ()=> showLogin());
      modal.querySelector('#sessao-usuario-signup').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const name = modal.querySelector('#sessao-usuario-signup-name').value.trim();
        const email = modal.querySelector('#sessao-usuario-signup-email').value.trim().toLowerCase();
        const password = modal.querySelector('#sessao-usuario-signup-password').value;
        const msgEl = modal.querySelector('#sessao-usuario-signup-msg');
        msgEl.textContent = '';
        if(password.length < 8){ msgEl.textContent = 'Senha muito curta (m√≠n 8 chars).'; return; }
        const users = loadUsers();
        if(users[email]){ msgEl.textContent = 'J√° existe uma conta com este e-mail.'; return; }
        const {hashHex, saltHex} = await derivePasswordHash(password, null);
        users[email] = {name, email, saltHex, hashHex, photoDataUrl: ''};
        saveUsers(users);
        setCurrent(email);
        closeModal();
        onAuthChange(true);
      });
    }

    // --- EmailJS integration will be invoked in forgot handler ---
    // We'll load and init EmailJS at the bottom of this script.

    function initForgotHandlers(){
      modal.querySelector('[data-action="close"]').addEventListener('click', closeModal);
      modal.querySelector('#sessao-usuario-to-login-2').addEventListener('click', ()=> showLogin());
      modal.querySelector('#sessao-usuario-forgot-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = modal.querySelector('#sessao-usuario-forgot-email').value.trim().toLowerCase();
        const msgEl = modal.querySelector('#sessao-usuario-forgot-msg');
        const successEl = modal.querySelector('#sessao-usuario-forgot-success');
        msgEl.textContent = ''; successEl.textContent=''; successEl.classList.add('sessao-usuario-hidden');
        const users = loadUsers();
        if(!users[email]){ msgEl.textContent = 'E-mail n√£o encontrado.'; return; }

        // generate token
        const token = Math.random().toString(36).slice(2,10).toUpperCase();
        const expiresAt = Date.now() + (1000*60*15); // 15 minutes
        saveResetToken(email, token, expiresAt);

        // prepare name for email
        const nomeParaEmail = (users[email].name && users[email].name.trim()) ? users[email].name.trim() : email.split('@')[0];

        // send via EmailJS
        // the template expects: to_name, to_email, token
        // service/template/public keys are baked below (replace if needed)
        const serviceId = 'service_q6u8vzl';
        const templateId = 'template_jpid2jq';

        const templateParams = {
          to_name: nomeParaEmail,
          to_email: email,
          token: token
        };

        // try sending email; fallback to showing token in UI
        if(window.emailjs && typeof window.emailjs.send === 'function'){
          window.emailjs.send(serviceId, templateId, templateParams)
            .then(function(response){
              successEl.textContent = 'E-mail de recupera√ß√£o enviado. Verifique sua caixa de entrada (ou spam).';
              successEl.classList.remove('sessao-usuario-hidden');
              setTimeout(()=>showReset(), 1400);
            }, function(error){
              console.error('EmailJS error:', error);
              successEl.textContent = 'N√£o foi poss√≠vel enviar o e-mail automaticamente. Use este token: ' + token;
              successEl.classList.remove('sessao-usuario-hidden');
              setTimeout(()=>showReset(), 1400);
            });
        } else {
          // EmailJS n√£o carregado ‚Äî exibir token para teste
          successEl.textContent = 'EmailJS n√£o dispon√≠vel. Use este token: ' + token;
          successEl.classList.remove('sessao-usuario-hidden');
          setTimeout(()=>showReset(), 1400);
        }
      });
    }

    function initResetHandlers(){
      modal.querySelector('[data-action="close"]').addEventListener('click', closeModal);
      modal.querySelector('#sessao-usuario-to-login-3').addEventListener('click', ()=> showLogin());
      modal.querySelector('#sessao-usuario-reset-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = modal.querySelector('#sessao-usuario-reset-email').value.trim().toLowerCase();
        const token = modal.querySelector('#sessao-usuario-reset-token').value.trim();
        const newPass = modal.querySelector('#sessao-usuario-reset-password').value;
        const msgEl = modal.querySelector('#sessao-usuario-reset-msg');
        msgEl.textContent = '';
        if(newPass.length < 8){ msgEl.textContent = 'Senha muito curta.'; return; }
        const stored = getResetToken(email);
        if(!stored || stored.token !== token || stored.expiresAt < Date.now()){ msgEl.textContent = 'Token inv√°lido ou expirado.'; return; }
        const users = loadUsers();
        if(!users[email]){ msgEl.textContent = 'Conta n√£o encontrada.'; return; }
        const {hashHex, saltHex} = await derivePasswordHash(newPass, null);
        users[email].hashHex = hashHex;
        users[email].saltHex = saltHex;
        saveUsers(users);
        removeResetToken(email);
        setCurrent(email);
        closeModal();
        onAuthChange(true);
      });
    }

    function initProfileHandlers(){
      modal.querySelector('[data-action="close"]').addEventListener('click', closeModal);
      modal.querySelector('#sessao-usuario-save-profile').addEventListener('click', async ()=>{
        const nameEl = modal.querySelector('#sessao-usuario-profile-name');
        const emailEl = modal.querySelector('#sessao-usuario-profile-email');
        const currentPassEl = modal.querySelector('#sessao-usuario-profile-current-password');
        const newPassEl = modal.querySelector('#sessao-usuario-profile-new-password');
        const fileEl = modal.querySelector('#sessao-usuario-profile-photo');
        const msgEl = modal.querySelector('#sessao-usuario-profile-msg');
        msgEl.textContent='';
        const newName = nameEl.value.trim();
        const newEmail = emailEl.value.trim().toLowerCase();
        const users = loadUsers();
        const current = getCurrent();
        if(!current || !users[current]){ msgEl.textContent='Erro: usu√°rio n√£o autenticado.'; return; }

        if(newEmail !== current && users[newEmail]){ msgEl.textContent='Outro usu√°rio j√° usa esse e-mail.'; return; }

        if(fileEl.files && fileEl.files[0]){
          const f = fileEl.files[0];
          const reader = new FileReader();
          reader.onload = function(ev){
            users[current].photoDataUrl = ev.target.result;
            finishUpdate();
          };
          reader.readAsDataURL(f);
        } else {
          finishUpdate();
        }

        async function finishUpdate(){
          if(newPassEl.value){
            if(!currentPassEl.value){ msgEl.textContent='Informe a senha atual para trocar a senha.'; return; }
            const {saltHex, hashHex: storedHash} = users[current];
            const {hashHex} = await derivePasswordHash(currentPassEl.value, saltHex);
            if(hashHex !== storedHash){ msgEl.textContent='Senha atual incorreta.'; return; }
            const newDerived = await derivePasswordHash(newPassEl.value, null);
            users[current].hashHex = newDerived.hashHex;
            users[current].saltHex = newDerived.saltHex;
          }

          users[current].name = newName || users[current].name;

          if(newEmail !== current){
            users[newEmail] = {...users[current], email:newEmail};
            delete users[current];
            saveUsers(users);
            setCurrent(newEmail);
          } else {
            saveUsers(users);
          }

          msgEl.classList.remove('sessao-usuario-error');
          msgEl.classList.add('sessao-usuario-success');
          msgEl.textContent = 'Perfil atualizado.';
          setTimeout(()=>{ closeModal(); onAuthChange(true); }, 900);
        }
      });

      const logoutBtn = modal.querySelector('#sessao-usuario-logout');
      logoutBtn.addEventListener('click', ()=>{ setCurrent(''); closeModal(); onAuthChange(false); });

      const fileInput = modal.querySelector('#sessao-usuario-profile-photo');
      if(fileInput){
        fileInput.addEventListener('change', (e)=>{
          const f = e.target.files[0];
          if(!f) return;
          const reader = new FileReader();
          reader.onload = (ev)=>{
            const img = modal.querySelector('#sessao-usuario-avatar-img');
            img && (img.outerHTML = `<img src="${ev.target.result}" class="sessao-usuario-avatar" id="sessao-usuario-avatar-img" />`);
          };
          reader.readAsDataURL(f);
        });
      }
    }

    // --- Auth UI state changes ---
    function onAuthChange(signedIn){
      const current = getCurrent();
      if(signedIn && current){
        const users = loadUsers();
        const u = users[current];
        floatingBtn.textContent = u && u.name ? (u.name.split(' ')[0]) : 'Conta';
        floatingBtn.title = 'Abrir perfil';
        floatingBtn.onclick = showProfile;
      } else {
        floatingBtn.textContent = 'Minha Conta';
        floatingBtn.title = 'Entrar / Registrar';
        floatingBtn.onclick = ()=> showLogin();
      }
    }
     // If page has element with id 'btn-minha-conta', use it instead of floating
    const existing = document.getElementById('btn-minha-conta');
    if(existing){
      existing.addEventListener('click', ()=> {
        const cur = getCurrent();
        if(cur) showProfile(); else showLogin();
      });
      floatingBtn.style.display = 'none';
    }

    // initialize
    (function init(){
      overlay.querySelectorAll('.sessao-usuario-close').forEach(b=>b.addEventListener('click', closeModal));
      const cur = getCurrent();
      onAuthChange(!!cur);
    })();

    // expose helper
    window.SessaoUsuarioLocal = {
      openLogin: ()=> showLogin(),
      openSignup: ()=> showSignup(),
      openProfile: ()=> showProfile(),
      isAuthenticated: ()=> !!getCurrent(),
      getCurrentUser: ()=>{
        const cur = getCurrent();
        const users = loadUsers();
        return cur && users[cur] ? {...users[cur], hashHex:undefined, saltHex:undefined} : null;
      }
    };

  })();
  </script>
  <!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
  // Inicializa o EmailJS
  emailjs.init("rljVhYiVragsliOtX"); // <-- Cole sua Public Key aqui

  async function enviarTokenEmail(nomeUsuario, emailUsuario, tokenGerado) {
    try {
      const resposta = await emailjs.send(
        "service_q6u8vzl,     // <-- Cole seu Service ID aqui
        "template_jpid2jq",    // <-- Cole seu Template ID aqui
        {
          user_name: nomeUsuario,
          user_email: emailUsuario,
          reset_token: tokenGerado
        }
      );

      if (resposta.status === 200) {
        alert("‚úÖ E-mail de recupera√ß√£o enviado com sucesso!");
      } else {
        alert("‚ö†Ô∏è N√£o foi poss√≠vel enviar o e-mail. C√≥digo: " + resposta.status);
      }
    } catch (erro) {
      console.error("Erro ao enviar e-mail:", erro);
      alert("‚ùå Ocorreu um erro ao enviar o e-mail. Verifique sua conex√£o ou configura√ß√£o do EmailJS.");
    }
  }

  // Exemplo de uso
  // enviarTokenEmail("Gabriel", "exemplo@gmail.com", "ABCD1234");
</script>
  </script>

</body>
</html>

